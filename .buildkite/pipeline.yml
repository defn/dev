{
    "env": {
        "BUILDKITE_GIT_MIRRORS_PATH": "/cache/git",
        "BUILDKITE_GIT_MIRRORS_SKIP_UPDATE": "1"
    },
    "steps": [
        {
            "label": "buildkite-docker-image",
            "key": "buildkite-docker-image",
            "plugins": [
                {
                    "kubernetes": {
                        "podSpec": {
                            "containers": [
                                {
                                    "image": "cache.defn.run:5000/dfd:class-latest",
                                    "args": [
                                        "'set -e\ncd\ngit fetch\ngit reset --hard $BUILDKITE_COMMIT\nsource .bash_profile\ncd m/i/class\nmake buildkite'"
                                    ],
                                    "imagePullPolicy": "Always",
                                    "securityContext": {
                                        "runAsNonRoot": true,
                                        "runAsUser": 1000,
                                        "runAsGroup": 1000
                                    },
                                    "volumeMounts": [
                                        {
                                            "name": "docker-socket",
                                            "mountPath": "/var/run/docker.sock"
                                        }
                                    ],
                                    "command": [
                                        "bash",
                                        "-c"
                                    ]
                                }
                            ],
                            "volumes": [
                                {
                                    "name": "docker-socket",
                                    "hostPath": {
                                        "path": "/var/run/docker.sock"
                                    }
                                }
                            ]
                        }
                    }
                }
            ],
            "depends_on": []
        },
        {
            "label": "bazel-build",
            "key": "bazel-build",
            "plugins": [
                {
                    "kubernetes": {
                        "podSpec": {
                            "containers": [
                                {
                                    "image": "cache.defn.run:5000/dfd:class-latest",
                                    "args": [
                                        "'set -e\ncd\ngit fetch\ngit reset --hard $BUILDKITE_COMMIT\nsource .bash_profile\ngit config --global user.email you@example.com\ngit config --global user.name YourName\nbin/persist-cache\ncd m\necho --- bazel\nexport DFD_CI_BAZEL_OPTIONS=--remote_download_minimal\n../bin/b build\necho --- bazel again\n../bin/b build'"
                                    ],
                                    "imagePullPolicy": "Always",
                                    "securityContext": {
                                        "runAsNonRoot": true,
                                        "runAsUser": 1000,
                                        "runAsGroup": 1000
                                    },
                                    "volumeMounts": [
                                        {
                                            "name": "work",
                                            "mountPath": "/home/ubuntu/work"
                                        }
                                    ],
                                    "command": [
                                        "bash",
                                        "-c"
                                    ]
                                }
                            ],
                            "volumes": [
                                {
                                    "name": "work",
                                    "emptyDir": {}
                                }
                            ]
                        }
                    }
                }
            ],
            "depends_on": []
        },
        {
            "label": "latest-class-docker-image",
            "key": "latest-class-docker-image",
            "plugins": [
                {
                    "kubernetes": {
                        "podSpec": {
                            "containers": [
                                {
                                    "image": "cache.defn.run:5000/dfd:class-latest",
                                    "args": [
                                        "'set -e\ncd\ngit fetch\ngit reset --hard $BUILDKITE_COMMIT\nsource .bash_profile\ncd m/i/class\nmake class-latest'"
                                    ],
                                    "imagePullPolicy": "Always",
                                    "securityContext": {
                                        "runAsNonRoot": true,
                                        "runAsUser": 1000,
                                        "runAsGroup": 1000
                                    },
                                    "volumeMounts": [
                                        {
                                            "name": "docker-socket",
                                            "mountPath": "/var/run/docker.sock"
                                        }
                                    ],
                                    "command": [
                                        "bash",
                                        "-c"
                                    ]
                                }
                            ],
                            "volumes": [
                                {
                                    "name": "docker-socket",
                                    "hostPath": {
                                        "path": "/var/run/docker.sock"
                                    }
                                }
                            ]
                        }
                    }
                }
            ],
            "depends_on": []
        },
        {
            "label": "load-class-docker-image",
            "key": "load-class-docker-image",
            "plugins": [
                {
                    "kubernetes": {
                        "podSpec": {
                            "containers": [
                                {
                                    "image": "cache.defn.run:5000/dfd:class-latest",
                                    "args": [
                                        "'set -e\ncd\necho --- git log\ngit log | head'\ndu -sh ~/work ~/work/*"
                                    ],
                                    "imagePullPolicy": "Always",
                                    "securityContext": {
                                        "runAsNonRoot": true,
                                        "runAsUser": 1000,
                                        "runAsGroup": 1000
                                    },
                                    "volumeMounts": [],
                                    "command": [
                                        "bash",
                                        "-c"
                                    ]
                                }
                            ],
                            "volumes": []
                        }
                    }
                }
            ],
            "depends_on": [
                "latest-class-docker-image"
            ]
        }
    ]
}
