#!/usr/bin/env bash

set -efu

if [[ -n "${1:-}" ]]; then
    chdir="$1"; shift
else
    exec def
fi

cd "$chdir"

if [[ -n "${1:-}" ]]; then
    eval "$(direnv hook bash)"
    direnv allow
    _direnv_hook
    exec "$@"
else
    if [[ ! -f flake.nix ]]; then (set +f; cp ~/min/*.nix .; git add *.nix); fi
    if [[ ! -f .envrc ]]; then echo use flake > .envrc; fi
    mkdir -p .direnv
    touch .direnv/.ignore
    if test "?? .direnv/" == "$(git status -sb .direnv | tail +2)"; then echo .direnv >> .gitignore; fi
    direnv allow
    code-server .
fi
