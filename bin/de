#!/usr/bin/env bash

set -efu

if [[ -n "${1:-}" ]]; then
    case "${1}" in
        /*)
            exec def "${1#/}"
            ;; 
        *)
            chdir="$1"; shift
            ;;
    esac
else
    exec def 
fi

cd "$chdir"

if [[ -n "${1:-}" ]]; then
    eval "$(~/.nix-profile/bin/direnv hook bash)"
    direnv allow
    _direnv_hook
    exec "$@"
else
    if [[ ! -f flake.nix ]]; then cp ~/etc/flake.nix.template flake.nix; fi
    if [[ ! -f .envrc ]]; then echo use flake > .envrc; fi
    mkdir -p .direnv
    touch .direnv/.ignore
    if test "?? .direnv/" == "$(git status -sb .direnv | tail +2)"; then echo .direnv >> .gitignore; fi
    direnv allow
    code-server .
fi