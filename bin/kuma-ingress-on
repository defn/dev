#!/usr/bin/env bash

function main {
	set -efu

	local zone="${1:-$(~ubuntu/bin/e wait-tailscale-domain)}"

	local pth_dp="${1:-$HOME/etc/ingress-dp.yaml}"

	kumactl generate zone-ingress-token --zone="$zone" | sudo sudo -u kuma tee /tmp/ingress-token >/dev/null

	cp "$pth_dp" /tmp/

	exec sudo -u kuma \
		kuma-dp run 
			--dataplane-token-file=/tmp/ingress-token --dataplane-file=/tmp/ingress-dp.yaml \
      --proxy-type=ingress \
			--dataplane-var tsip=$(tailscale ip -4)
}

main "$@"
