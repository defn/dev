#!/usr/bin/env bash

# env region=us-west-2 sso_region=us-west-2 sso_url=https://.../start name=spiral

function main {
	cat <<EOF
[profile $name]
region=$region

EOF

	aws organizations list-accounts | jq -r '.Accounts[] | "\(.Id) \(.Name) \(.Status)"' | sort | while read -r id account type; do
		if [[ "${account}" == "${name}" ]]; then
			export account='org'
		fi
		cat <<EOF
[profile $name-$account-sso]
sso_start_url=$sso_url
sso_region=$sso_region
sso_role_name=Administrator
sso_account_id=$id
output=json

[profile $name-$account]
credential_process=aws-vault exec $name-$account-sso --json
region=$region

[profile $name-$account-org]
source_profile=$name
role_arn=arn:aws:iam::$id:role/OrganizationAccountAccessRole
region=$region

[profile $name-$account-adm]
credential_process=aws-vault exec $name-$account-org --json
region=$region

EOF
	done
}

main "$@"
