#!/usr/bin/env bash

function main {
    set -efu

    local tmp="$(mktemp -d -t XXXXXX)"

    export VAULT_ADDR=http://vault.vault.svc:8200

    cd "$tmp"

    vault write pki/issue/gyre.defn.dev common_name=admin.gyre.defn.dev ttl=1m -format=json > "meh.json"
    cat "meh.json" | jq -r '.data.certificate' > "meh.crt"
    cat "meh.json" | jq -r '.data.private_key' > "meh.key"

    aws_signing_helper credential-process \
        --certificate "meh.crt" --private-key "meh.key" \
        --trust-anchor-arn arn:aws:rolesanywhere:us-east-1:319951235442:trust-anchor/d5da756a-efc2-4fd0-ac73-1d0998f2f555 \
        --profile-arn arn:aws:rolesanywhere:us-east-1:319951235442:profile/f903c6fc-931e-4163-bc62-6e44252526ac \
        --role-arn arn:aws:iam::319951235442:role/defn 

    cd -

    rm -rf "$tmp"
}

main "$@"
