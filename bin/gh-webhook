#!/usr/bin/env bash

set -exfu

exec 1>>/tmp/wh.log 2>&1

function main {

    local event=$1; shift
    local repo=$1; shift
    local ref=$1; shift
    local commit=$1; shift

    local branch="${ref##refs/heads/}"

    if [[ "${branch}" != "${WH_BRANCH:-}" ]]; then
        echo "ERROR: payload branch ${branch} does not match working branch ${WH_BRANCH:-}" 1>&2
        return 1
    fi
    
    mkdir -p /tmp/meh
    cd /tmp/meh
    git clone -b "$branch" --depth 1 "$repo" "$commit" || true
    cd "$commit"
    git fetch
    git reset --hard "$commit"

    time (
        nix build
        nix path-info --all | grep -v '\.drv$' | xargs nix copy --verbose --to 'file:///cache/nix?compression-level=0&parallel-compression=true&secret-key=/tmp/cache-priv-key.pem'
        nix path-info --all | grep -v '\.drv$' | xargs nix copy --verbose --to 'file:///tmp/cache/nix?compression-level=0&parallel-compression=true'
    )

    time earthly --no-output --push +build-root
    time earthly --no-output --push +build-fly
    time earthly --no-output --push +build-nix
    time earthly --no-output --push +build-devcontainer

    time earthly --no-output --push +build-nix-root
    time earthly --no-output --push +build-nix-installed
    time earthly --no-output --push +build-nix-install
    time earthly --no-output --push +build-flake-root

    set +x

    sync
    echo "done: $commit"
}

main "$@"
