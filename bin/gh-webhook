#!/usr/bin/env bash

function main {
    eval "$(direnv hook bash)"
    direnv allow
    _direnv_hook

    set -exfu

    for a in {nix-{root,installed,empty},flake-root,devcontainer}; do
        time earthly --no-output --push +build-$a
        time docker pull ghcr.io/defn/dev:latest-$a
        #time skopeo copy docker://ghcr.io/defn/dev:latest-$a docker://169.254.32.1:5000/defn/dev:latest-$a --multi-arch all --dest-tls-verify=false --insecure-policy || true
    done
}

main "$@"
