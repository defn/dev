#!/usr/bin/env bash

function main {
	set -efu -o pipefail

	case "${1:-}" in
	login)
		shift
		local account
		account="$(grep '^\[profile ' ~/.aws/config | grep \\-sso | awk '{print $2}' | cut -d']' -f1 | sort | fzf --query="${1:-}" --select-1)"
		b logout
		aws-vault login "${account}"
		;;
	logout)
		open https://signin.aws.amazon.com/oauth?Action=logout &
		;;
	exec)
		shift
		local account
		account="$(grep '^\[profile ' ~/.aws/config | grep \\-sso | awk '{print $2}' | cut -d']' -f1 | sort | fzf --query="${1:-}" --select-1)"
		shift
		aws-vault exec "${account}" -- "$@"
		;;
	tilt)
		shift
		open 'http://localhost/r/(all)/overview'
		;;
	*)
		local bazel_prefix
		bazel_prefix="$(git rev-parse --show-prefix | sed 's#/$##; s#^m/##')"

		if [[ $# == 0 ]]; then
			bazel query --ui_event_filters=-info --noshow_progress --noshow_loading_progress "//${bazel_prefix}/..." | sed "s#^//${bazel_prefix}:##"
		else
			local rule

			if [[ $1 == "build" ]]; then
				shift

				if [[ $# == 0 ]]; then
					rule="/..."
				else
					rule=":$1"
					shift
				fi

				exec bazel build \
					--ui_event_filters=-info,-stdout,-stderr --noshow_progress --noshow_loading_progress \
					--sandbox_writable_path=/nix --sandbox_writable_path=/home/ubuntu/.cache/nix \
					"//${bazel_prefix}${rule}"
			else
				rule="$1"
				shift

				exec bazel run \
					--ui_event_filters=-info,-stdout,-stderr --noshow_progress --noshow_loading_progress \
					--sandbox_writable_path=/nix --sandbox_writable_path=/home/ubuntu/.cache/nix \
					"//${bazel_prefix}:${rule}" -- "$@"
			fi
		fi
		;;
	esac
}

main "$@"
