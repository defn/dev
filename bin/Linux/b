#!/usr/bin/env bash

function main {
	set -efu

	case "${1:-}" in
		login)
			shift
			local account="$(grep '^\[profile ' ~/.aws/config | grep \\-sso | awk '{print $2}' | cut -d']' -f1 | sort | fzf --query="${1:-}" --select-1)"
			b logout
			aws-vault login "$account"
			;;
		logout)
			open https://signin.aws.amazon.com/oauth?Action=logout&redirect_uri=https://aws.amazon.com
			;;
		exec)
			shift
			local account="$(grep '^\[profile ' ~/.aws/config | grep \\-sso | awk '{print $2}' | cut -d']' -f1 | sort | fzf --query="${1:-}" --select-1)"
			shift
			aws-vault exec "$account" -- "$@"
			;;
		tilt)
			shift
			open 'http://localhost/r/(all)/overview'
			;;
		*)
			exec open "https://$(wait-tailscale-domain)/$*/"
			;;
	esac
}

main "$@"
