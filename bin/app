#!/usr/bin/env bash

function main {
	set -efu -o pipefail

	case "${1-}" in
	repo)
		exec env KUBECONFIG=$HOME/.kube/config.argocd argocd --core "$@"
		;;
	local)
		shift
		app="$1"; shift
		version="$1"; shift
		case "${app}" in
		/*) app="$(app list | tail -n +2 | awk '{print $1}' | fzf --query="${app#/}" --select-1)" ;;
		esac

		exec env KUBECTL_EXTERNAL_DIFF="dyff between --color=on --truecolor=on " KUBECONFIG=$HOME/.kube/config.argocd argocd --core app diff "${app}" --server-side-generate --local "${version}"
		;;
	diff)
		shift
		app="$1"; shift
		version="$1"; shift
		case "${app}" in
		/*) app="$(app list | tail -n +2 | awk '{print $1}' | fzf --query="${app#/}" --select-1)" ;;
		esac
		
		exec env KUBECTL_EXTERNAL_DIFF="dyff between --color=on --truecolor=on " KUBECONFIG=$HOME/.kube/config.argocd argocd --core app diff "${app}" --revision "${version}" "$@"
		;;
	sync | get | wait | terminate-op | resources | logs | diff)
		case "${2-}" in
		/*)
			exec env KUBECONFIG=$HOME/.kube/config.argocd argocd --core app "$1" "$(app list | tail -n +2 | awk '{print $1}' | fzf --query="${2#/}" --select-1 || true)"
			;;
		*)
			exec env KUBECONFIG=$HOME/.kube/config.argocd argocd --core app "$1" "${2-}"
			;;
		esac
		;;
	*)
		exec env KUBECONFIG=$HOME/.kube/config.argocd argocd --core app "$@"
		;;
	esac
}

main "$@"
