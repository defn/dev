#!/usr/bin/env bash

function main {
	set -efu

	sudo rm -f /tmp/dev-token /tmp/kuma-al-dev-default.sock
	kumactl generate dataplane-token | sudo sudo -u kuma tee /tmp/dev-token >/dev/null

	cp ~/etc/dev-dp.yaml /tmp/

	exec sudo -u kuma \
		kuma-dp run \
			--dataplane-token-file=/tmp/dev-token \
			--dataplane-file=/tmp/dev-dp.yaml \
			--dataplane-var tsip=$(tailscale ip -4)
}

main "$@"
