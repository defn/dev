#!/usr/bin/env bash

function main {
	set -efu

	local pth_dp="${1:-$HOME/etc/dev-dp.yaml}"

	cp "$pth_dp" /tmp/dev-dp.yaml

	kumactl generate dataplane-token | sudo sudo -u kuma tee /tmp/dev-token >/dev/null

	exec sudo -E -u kuma \
		kuma-dp run \
			--dataplane-token-file=/tmp/dev-token \
			--dataplane-file=/tmp/dev-dp.yaml \
			--dataplane-var hostname=$(~/bin/e wait-tailscale-domain | cut -d. -f1 ) \
			--dataplane-var tsip=$(tailscale ip -4)
}

main "$@"
