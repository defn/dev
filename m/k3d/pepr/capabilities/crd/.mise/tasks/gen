#!/usr/bin/env bash
#MISE description="Generate CRDs from CUE schemas"

set -efu

read_file() {
	f="$1"
	shift
	k="$1"
	shift
	while IFS= read -r line; do
		if [[ $line == *"openAPIV3Schema"* ]]; then
			echo "        openAPIV3Schema:"
			echo "          type: object"
			echo "          properties:"
			echo "            spec:"
			echo "              type: object"
			echo "              required:"
			cat "$f" | yq -P ".components.schemas.${k}.required" | sed 's#^#                 #'
			echo "              properties:"
			cat "$f" | yq -P ".components.schemas.${k}.properties" | sed 's#^#                 #'
		else
			echo "$line"
		fi
	done
}

for a in Script; do
	# Generate OpenAPI YAML from CUE
	cue def api.$a.cue --force -o api.$a.yaml --out openapi+yaml
	sed -i '' "1i\\
# auto-generated: api.$a.cue
" api.$a.yaml

	# Generate TypeScript types from OpenAPI
	npx openapi-typescript api.$a.yaml -o $a.d.ts
	sed -i '' "1i\\
// auto-generated: api.$a.yaml
" $a.d.ts

	# Generate Kubernetes CRD manifest
	cue export --out yaml -e crd.$a | read_file api.$a.yaml $a >crd.$a.yaml
	sed -i '' "1i\\
# auto-generated: api.$a.cue
" crd.$a.yaml
done

trunk fmt
