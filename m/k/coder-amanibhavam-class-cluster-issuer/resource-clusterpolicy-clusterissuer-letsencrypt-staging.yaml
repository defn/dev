#ManagedBy: cue

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: letsencrypt-staging-clusterissuer
spec:
  generateExistingOnPolicyUpdate: true
  rules:
    - name: create-cluster-issuer
      match:
        any:
          - resources:
              names:
                - letsencrypt-staging
              kinds:
                - Secret
              namespaces:
                - cert-manager
      generate:
        synchronize: true
        apiVersion: cert-manager.io/v1
        kind: ClusterIssuer
        name: letsencrypt-staging
        data:
          spec:
            acme:
              server: https://acme-staging-v02.api.letsencrypt.org/directory
              email: '{{request.object.data.zerossl_email | base64_decode(@)}}'
              privateKeySecretRef:
                name: letsencrypt-staging-acme
              solvers:
                - selector: {}
                  dns01:
                    cloudflare:
                      email: '{{request.object.data.cloudflare_email | base64_decode(@)}}'
                      apiTokenSecretRef:
                        name: letsencrypt-staging
                        key: cloudflare_api_token
