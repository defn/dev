#ManagedBy: cue

apiVersion: karpenter.k8s.aws/v1alpha1
kind: AWSNodeTemplate
metadata:
  name: default
spec:
  amiFamily: Custom
  amiSelector:
    karpenter.sh/discovery: k3d-dfd
  subnetSelector:
    karpenter.sh/discovery: k3d-dfd
  securityGroupSelector:
    karpenter.sh/discovery: k3d-dfd
  instanceProfile: coder-amanibhavam-dev
  blockDeviceMappings:
    - deviceName: /dev/sda1
      ebs:
        volumeSize: 40Gi
        volumeType: gp3
        encrypted: true
        deleteOnTermination: true
  userData: |
    MIME-Version: 1.0
    Content-Type: multipart/mixed; boundary="BOUNDARY"
    --BOUNDARY
    Content-Type: text/x-shellscript; charset="us-ascii"
    #!/bin/bash

    set -exfu
    TOKEN="$(curl -sSL -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")"
    instance="$(curl -sSL -H "X-aws-ec2-metadata-token: $TOKEN" -v http://169.254.169.254/latest/meta-data/instance-id)"

    # docker exec -ti  k3d-dfd-server-0 cat /var/lib/rancher/k3s/server/agent-token
    k3d node create "$instance" --role agent --image quay.io/defn/dev:latest-k3d --cluster https://100.123.125.88:6443 --token K10a5501ccdd507b442c851c11172bbc3f9f1ac46895c169153d448f6b9826d7978::server:poPkbSDCfsqXUPsJOTFl

    --BOUNDARY
