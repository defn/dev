#ManagedBy: cue

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: coder-connection-url
spec:
  generateExistingOnPolicyUpdate: true
  rules:
    - name: create-secret-coder-connection-url
      match:
        any:
          - resources:
              names:
                - coder.coder-db.credentials.postgresql.acid.zalan.do
              kinds:
                - Secret
              namespaces:
                - coder
      generate:
        synchronize: true
        apiVersion: v1
        kind: Secret
        name: coder.coder-db.connection-url
        namespace: coder
        stringData:
          coder_pg_connection_url: 'postgresql://{{request.object.data.username | base64_decode(@)}}:{{request.object.data.password | base64_decode(@)}}@coder-db:5432/coder?sslmode=require '
