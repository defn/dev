# auto-generated: bazel.cue

load("@rules_shell//shell:sh_test.bzl", "sh_test")
load("//bashel/ex-macros:macros.bzl", "archive_directory", "archive_info")

genrule(
    name = "raw_configs",
    outs = [
        "raw/app.conf",
        "raw/database.conf",
        "raw/cache.conf",
    ],
    cmd = """
mkdir -p $(@D)/raw
echo 'application configuration settings' > $(@D)/raw/app.conf
echo 'database connection parameters' > $(@D)/raw/database.conf
echo 'cache backend configuration' > $(@D)/raw/cache.conf
""",
)

genrule(
    name = "normalized_app_conf",
    srcs = [
        ":raw_configs",
    ],
    outs = [
        "normalized/app.conf",
    ],
    cmd = """
set -- $(locations :raw_configs)
$(location //bashel/ex-genrule:uppercase_sh) input=$$1 $@
""",
    tools = [
        "//b/lib:lib_sh",
        "//bashel/ex-genrule:uppercase_sh",
    ],
)

genrule(
    name = "normalized_database_conf",
    srcs = [
        ":raw_configs",
    ],
    outs = [
        "normalized/database.conf",
    ],
    cmd = """
set -- $(locations :raw_configs)
$(location //bashel/ex-genrule:uppercase_sh) input=$$2 $@
""",
    tools = [
        "//b/lib:lib_sh",
        "//bashel/ex-genrule:uppercase_sh",
    ],
)

genrule(
    name = "normalized_cache_conf",
    srcs = [
        ":raw_configs",
    ],
    outs = [
        "normalized/cache.conf",
    ],
    cmd = """
set -- $(locations :raw_configs)
$(location //bashel/ex-genrule:uppercase_sh) input=$$3 $@
""",
    tools = [
        "//b/lib:lib_sh",
        "//bashel/ex-genrule:uppercase_sh",
    ],
)

filegroup(
    name = "normalized_configs",
    srcs = [
        ":normalized_app_conf",
        ":normalized_cache_conf",
        ":normalized_database_conf",
    ],
)

genrule(
    name = "config_size_report",
    srcs = [
        ":normalized_app_conf",
    ],
    outs = [
        "reports/app_size.txt",
    ],
    cmd = """
$(location //bashel/ex-genrule:word_count_sh) input=$(location :normalized_app_conf) $@
""",
    tools = [
        "//b/lib:lib_sh",
        "//bashel/ex-genrule:word_count_sh",
    ],
)

archive_directory(
    name = "production_config_bundle",
    dir = ":normalized_configs",
    prefix = "prod-configs",
)

archive_directory(
    name = "staging_config_bundle",
    dir = ":normalized_configs",
    prefix = "staging-configs",
)

archive_info(
    name = "production_bundle_info",
    archive = ":production_config_bundle",
)

archive_info(
    name = "staging_bundle_info",
    archive = ":staging_config_bundle",
)

filegroup(
    name = "all_outputs",
    srcs = [
        ":config_size_report",
        ":normalized_configs",
        ":production_bundle_info",
        ":production_config_bundle",
        ":staging_bundle_info",
        ":staging_config_bundle",
    ],
)

sh_test(
    name = "test",
    srcs = [
        "test.sh",
    ],
    data = [
        ":all_outputs",
        "//bashel/bazel:bazel_cue",
        "//bashel/ex-genrule:uppercase_sh",
        "//bashel/ex-genrule:word_count_sh",
        "//bashel/ex-macros:create_archive_sh",
        "//bashel/ex-macros:list_archive_sh",
    ],
)
