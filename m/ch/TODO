echo 'deb http://download.opensuse.org/repositories/home:/cloud-hypervisor/xUbuntu_24.04/ /' | sudo tee /etc/apt/sources.list.d/home:cloud-hypervisor.list
curl -fsSL https://download.opensuse.org/repositories/home:cloud-hypervisor/xUbuntu_24.04/Release.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/home_cloud-hypervisor.gpg > /dev/null
sudo apt update
sudo apt install cloud-hypervisor qemu-system mtools dosfstools

sudo setcap cap_net_admin+ep $(which cloud-hypervisor)

gw="$(ip route show default | awk '{print $5}')"
sudo sysctl -w net.ipv4.ip_forward=1
sudo iptables -t nat -A POSTROUTING -s 192.168.249.0/24 -o ${gw} -j MASQUERADE
sudo iptables -A FORWARD -s 192.168.249.0/24 -o ${gw} -j ACCEPT
sudo iptables -A FORWARD -d 192.168.249.0/24 -m state --state RELATED,ESTABLISHED -i ${gw} -j ACCEPT

# Create bridge for VM networking
sudo ip link add name chbr0 type bridge
sudo ip addr add 192.168.249.1/24 dev chbr0
sudo ip link set chbr0 up

# Create and configure tap devices for VMs
for tap in ch-tap-jammy ch-tap-noble ch-tap-noble-1 ch-tap-noble-2 ch-tap-noble-3; do
	sudo ip tuntap add $tap mode tap
	sudo ip link set $tap master chbr0
	sudo ip link set $tap up
done

wget -nc https://github.com/cloud-hypervisor/rust-hypervisor-firmware/releases/download/0.5.0/hypervisor-fw
wget -nc https://github.com/cloud-hypervisor/edk2/releases/download/ch-a54f262b09/CLOUDHV.fd

for a in jammy noble; do
	wget -nc https://cloud-images.ubuntu.com/$a/current/$a-server-cloudimg-amd64.img
	rm -f $a-server-cloudimg-amd64.raw
	qemu-img convert -p -f qcow2 -O raw $a-server-cloudimg-amd64.img $a-server-cloudimg-amd64.raw
	qemu-img resize -f raw $a-server-cloudimg-amd64.raw 100G
done

a=noble
for n in 1 2 3; do
	rm -f $a-$n-server-cloudimg-amd64.raw
	qemu-img convert -p -f qcow2 -O raw $a-server-cloudimg-amd64.img $a-$n-server-cloudimg-amd64.raw
	qemu-img resize -f raw $a-$n-server-cloudimg-amd64.raw 30G
done

a=noble
for n in 1 2 3; do
	rm -f $a-$n-cloudinit.img
	cp network-$a-$n network-config
	mkdosfs -n CIDATA -C $a-$n-cloudinit.img 8192
	mcopy -oi $a-$n-cloudinit.img -s user-data ::
	mcopy -oi $a-$n-cloudinit.img -s meta-data ::
	mcopy -oi $a-$n-cloudinit.img -s network-config ::
done

rm -f ubuntu-cloudinit.img
cp network-jammy network-config
mkdosfs -n CIDATA -C ubuntu-cloudinit.img 8192
mcopy -oi ubuntu-cloudinit.img -s user-data ::
mcopy -oi ubuntu-cloudinit.img -s meta-data ::
mcopy -oi ubuntu-cloudinit.img -s network-config ::

rm -f noble-cloudinit.img
cp network-noble network-config
mkdosfs -n CIDATA -C noble-cloudinit.img 8192
mcopy -oi noble-cloudinit.img -s user-data ::
mcopy -oi noble-cloudinit.img -s meta-data ::
mcopy -oi noble-cloudinit.img -s network-config ::

sudo cloud-hypervisor \
	--kernel ./hypervisor-fw \
	--cpus boot=4 \
	--memory size=4G \
	--net "tap=ch-tap-jammy,mac=,ip=,mask=" \
	--console off \
	--serial tty \
	--disk path=jammy-server-cloudimg-amd64.raw \
	       path=ubuntu-cloudinit.img

sudo cloud-hypervisor \
	--kernel ./CLOUDHV.fd \
	--cpus boot=4 \
	--memory size=4G \
	--net "tap=ch-tap-noble,mac=,ip=,mask=" \
	--console off \
	--serial tty \
	--disk path=noble-server-cloudimg-amd64.raw \
	       path=noble-cloudinit.img

# Multiple Noble VMs
for n in 1 2 3; do
	sudo cloud-hypervisor \
		--kernel ./CLOUDHV.fd \
		--cpus boot=8 \
		--memory size=16G \
		--net "tap=ch-tap-noble-$n,mac=,ip=,mask=" \
		--console off \
		--serial tty \
		--disk path=noble-$n-server-cloudimg-amd64.raw \
		       path=noble-$n-cloudinit.img &
done
wait
