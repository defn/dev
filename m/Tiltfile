#!/usr/bin/env python

load("ext://restart_process", "custom_build_with_restart")

# local registry
default_registry("cache.defn.run:5000")

# code-server
local_resource(
    "code-server",
    serve_cmd=[
        "bash",
        "-c",
        """
            cd
            source .bash_profile
            cd ~/m/pkg/codeserver
            exec nix develop --command code-server --auth none --port 13337
        """,
    ],
)

# swap
local_resource(
    "swap",
    serve_cmd=[
        "bash",
        "-c",
        """
            if [[ "$(df -klh /mnt/docker | tail -1 | awk '{print $NF}')" == "/mnt/docker" ]]; then
                if ! test -f /mnt/docker/swap; then
                    sudo dd if=/dev/zero of=/mnt/docker/swap bs=1M count=8192
                    sudo chmod 0600 /mnt/docker/swap
                    sudo mkswap /mnt/docker/swap
                    sudo swapon /mnt/docker/swap
                fi
            fi
            sleep infinity
        """,
    ],
)
