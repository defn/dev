#!/usr/bin/env python

load("ext://restart_process", "custom_build_with_restart")

analytics_settings(False)

default_registry("169.254.32.1:5000")

local_resource(
    "code-server",
    serve_cmd=[
        "bash",
        "-c",
        """
            cd ~/m
            exec code-server --auth none --port 13337
            """,
    ],
)

local_resource(
    "buildkite",
    serve_cmd=[
        "bash",
        "-c",
        """
            cd ~/m
            make ci timeout=3600
            """,
    ],
)

local_resource(
    "pnpm",
    serve_cmd=[
        "bash",
        "-c",
        """
            cd ~/m/w
            $(MAKE) install
            npx pnpm dev
            """,
    ],
)

# local_resource(
#    "hugo",
#    serve_cmd=[
#        "bash",
#        "-c",
#        """
#            cd ~/m/defn/dev/www
#            npm install
#            exec npm run dev
#            """,
#    ],
# )
#
# local_resource(
#    "temporal",
#    serve_cmd=[
#        "bash",
#        "-c",
#        """
#            cd ~/m
#            exec temporal server start-dev
#            """,
#    ],
# )

local_resource(name="build-cli", cmd="make build", deps=["./cmd", "./command"])

custom_build_with_restart(
    ref="service-cli",
    command="make image tag=$EXPECTED_REF",
    deps=["/tmp/cli"],
    trigger=["/tmp/cli"],
    entrypoint=["/cli"],
    live_update=[
        sync("/tmp/cli", "/cli"),
    ],
)

k8s_yaml(local("cd cmd && make manifest"))

k8s_resource("service-cli", port_forwards="8080:8080", resource_deps=["build-cli"])
