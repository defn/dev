# ACUTE - Accumulate, Configure, Unify, Transform, Execute

ACUTE is a configuration and infrastructure management system that uses CUE as a unified source of truth, transforming it to tool-specific formats, and executing tools to generate outputs.

This directory implements a layered CUE configuration system that separates concerns between raw data accumulation, schema-based configuration, unification, transformation, and execution.

## ACUTE Architecture

ACUTE follows a five-phase pipeline:

1. **Accumulate** - Gather raw data from multiple sources (APIs, files, commands)
2. **Configure** - Apply CUE schemas to validate and structure accumulated data
3. **Unify** - Consolidate configured data from all sources into unified CUE
4. **Transform** - Convert CUE to tool/service-specific formats (JSON, YAML, Terraform, etc.)
5. **Execute** - Tools consume transformed formats to generate outputs (docs, infrastructure, deployments)

## Directory Structure

```
c/
├── intention/      # CUE schemas for validation
├── definition/     # Raw data sources (AWS, repos, etc.)
│   └── accum.sh    # Gather data from repo.yaml
├── application/    # API clients (GitHub repository metadata)
│   └── accum.sh    # Fetch from GitHub API
├── execution/      # Tool outputs (Kustomize, etc.)
│   └── accum.sh    # Gather from kubectl kustomize
├── accumulate.sh   # Accumulate - Calls all accum.sh scripts to gather raw data
├── configure.sh    # Configure - Process and prepare data for unification
├── unify.sh        # Unify - Apply schemas and consolidate data into CUE
├── transform.sh    # Transform - Convert CUE to tool-specific formats
├── execute.sh      # Execute - Build documentation site and run other tools
├── docs/           # Execute output - Generated Astro.js documentation site
└── README.md       # This file
```

### `intention/` - CUE Schemas

Contains CUE schema definitions that define the structure and constraints for configuration data.

- `repo.cue` - Schema for repository definitions
- `resource.cue` - Schema for Kubernetes resources

These schemas define the intended structure of data without providing actual values.

### `definition/` - Configuration Files

Contains concrete configuration data imported from YAML files.

- `accum.sh` - Accumulates data from `repo.yaml`
- `gen.cue` - Generated CUE output from accum.sh
- `aws/aws.cue` - AWS organization and account definitions
- Provides actual repository definitions with descriptions and metadata

### `execution/` - Tool Configurations

Contains tool-specific configurations and manifests.

- `accum.sh` - Accumulates data from `kubectl kustomize` output
- `gen.cue` - Generated CUE output from accum.sh
- Kustomize configurations for Kubernetes deployments
- Will contain other tool configurations (Terraform, Ansible, etc.)

### `application/` - API Clients

Contains data fetched from external APIs.

- `accum.sh` - Accumulates data from GitHub API
- `gen.cue` - Generated CUE output from accum.sh
- Fetches repository metadata including names, descriptions, URLs, and timestamps

### `docs/` - Documentation Site (Execute Output)

Astro.js + Starlight documentation site built from transformed CUE data. This is an Execute phase output - the site is generated by running Astro.js on YAML files created by `transform.sh`.

Features:

- **AWS Account Management**: Browse all AWS organizations and accounts with detailed information
- **AWS CLI Configuration**: Each account page displays copy-ready AWS SSO profile configuration
- **Searchable Content**: Full-text search powered by Pagefind
- **Mise Integration**: Run `mise run docs` to start the development server

See [docs/README.md](docs/README.md) for details.

## ACUTE Workflow Scripts

### accumulate.sh - Accumulate Raw Data

The `accumulate.sh` script handles the Accumulate phase:

```bash
./accumulate.sh
```

This runs three accumulation scripts in sequence:

1. **definition/accum.sh** - Accumulates raw data from `repo.yaml`
2. **execution/accum.sh** - Accumulates raw data from kustomize output
3. **application/accum.sh** - Accumulates raw data from GitHub API

Each `accum.sh` script gathers raw data and generates CUE files without validation.

### configure.sh - Configure Data for Unification

The `configure.sh` script handles the Configure phase:

```bash
./configure.sh
```

This script processes accumulated raw data and prepares it in a format optimal for CUE unification:

- Normalizes data formats
- Applies transformations
- Enriches data with computed fields
- Prepares data for schema validation

**Prerequisites:** Run `accumulate.sh` first to gather raw data.

**Note:** Currently a stub - implementation coming soon.

### unify.sh - Unify Data with Schemas

The `unify.sh` script handles the Unify phase:

```bash
./unify.sh
```

This script:

- Applies CUE schemas from `intention/` to validate data
- Unifies all data sources into single CUE structure
- Exports to YAML format

**Prerequisites:** Run `accumulate.sh` and `configure.sh` first.

### transform.sh - Transform to Tool-Specific Formats

The `transform.sh` script transforms unified CUE data into tool-specific formats:

```bash
./transform.sh
```

This will:

- Convert CUE data to YAML format for Astro.js documentation
- Generate files for `docs/src/content/` collections
- Create AWS account YAML files from `definition/aws/aws.cue`
- (Future) Generate Terraform configurations, Ansible playbooks, etc.

**Prerequisites:** Run `accumulate.sh`, `configure.sh`, and `unify.sh` first.

### execute.sh - Execute Tools to Generate Outputs

The `execute.sh` script runs tools that consume transformed data:

```bash
./execute.sh
```

This will:

- Build the Astro.js documentation site from transformed YAML
- (Future) Deploy infrastructure with Terraform, Ansible, kubectl, etc.

**Prerequisites:** Run `accumulate.sh`, `configure.sh`, `unify.sh`, and `transform.sh` first.

## Unification Model

The `main.cue` file imports all four packages and unifies them:

```cue
config: {
    resource: intention.resource  // Schema definition
    resource: execution.resource  // Actual resources (unified with schema)

    repo: intention.repo          // Schema definition
    repo: definition.repo         // Configuration data
    repo: application.repo        // API data (unified with schema and config)
}
```

CUE's unification ensures that:

- All `definition` data conforms to `intention` schemas
- All `execution` resources match `intention` schemas
- All `application` data is validated against `intention` schemas
- Conflicts between layers are detected at evaluation time

## Getting Started

1. **Accumulate raw data:**

   ```bash
   ./accumulate.sh
   ```

   This gathers raw data from all sources (YAML files, APIs, commands) and generates CUE files.

2. **Configure data:**

   ```bash
   ./configure.sh
   ```

   This processes and prepares accumulated data for optimal unification.

3. **Unify and validate data:**

   ```bash
   ./unify.sh
   ```

   This applies schemas and consolidates all data sources into unified CUE.

4. **Transform to tool-specific formats:**

   ```bash
   ./transform.sh
   ```

   This generates tool-specific files (YAML for Astro.js, etc.) from CUE data.

5. **Execute tools to generate outputs:**

   ```bash
   ./execute.sh
   ```

   This builds the Astro.js documentation site from transformed YAML.

**Quick Start:** Run `mise` in the `c/` directory to execute all phases automatically.

## Example: AWS Account YAML

After running `transform.sh`, AWS account files are generated in `docs/src/content/aws/`:

```yaml
# docs/src/content/aws/fogg/ci.yaml
account: ci
email: fogg-home@defn.sh
id: "812459563189"
name: home
org: fogg
sso_role: Administrator
aws_config: |-
  [profile fogg-ci]
  sso_account_id=812459563189
  sso_start_url=https://fogg-0.awsapps.com/start
  sso_role_name=Administrator
  sso_region=us-west-2
```

The file path determines the URL: `aws/fogg/ci.yaml` → `/aws/fogg/ci/`

The `aws_config` field is automatically generated by the CUE schema in `intention/aws.cue` and provides ready-to-use AWS CLI SSO profile configuration.

## Development Workflow

1. **Accumulate**: Run `./accumulate.sh` to gather raw data
   - Calls all `accum.sh` scripts in subdirectories
   - Each `accum.sh` collects data (YAML files, APIs, commands)
   - Raw data is converted to CUE format without validation

2. **Configure**: Run `./configure.sh` to process accumulated data
   - Normalizes data formats
   - Applies transformations and enrichments
   - Prepares data for optimal unification

3. **Unify**: Run `./unify.sh` to consolidate and validate
   - Applies CUE schemas from `intention/` to validate data
   - Unifies all data sources into single CUE structure
   - Exports to `main.yaml`

4. **Transform**: Run `./transform.sh` to convert CUE to tool-specific formats
   - Generates YAML for Astro.js documentation
   - (Future) Creates Terraform configs, Ansible playbooks, etc.

5. **Execute**: Run `./execute.sh` to generate final outputs
   - Builds documentation site with `npm run build`
   - (Future) Deploy infrastructure with `kubectl apply -k execution/`
   - (Future) Run Terraform, Ansible, etc.

**Quick Start:** Run `mise` in the `c/` directory to execute all phases (Accumulate → Configure → Unify → Transform → Execute).

This approach uses CUE as a single source of truth while supporting multiple tool ecosystems through format transformation.
