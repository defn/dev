name=district

python -mvenv venv
source venv/bin/activate
pip install certbot certbot-dns-cloudflare
cp cloudflare.ini.example cloudflare.ini
chmod 0600 cloudflare.ini
# put cloudflare token in cloudflare.ini
certbot certonly --dns-cloudflare --dns-cloudflare-credentials cloudflare.ini -d "*.${name}.defn.run" --config-dir . --work-dir . --logs-dir .

create github app at https://github.com/organizations/defn/settings/applications
use homepage https://coder.${name}.defn.run
callback https://coder.${name}.defn.run/api/v2/users/oauth2/github/callback

~/.envrc:
export coder_oauth2_github_allowed_orgs=defn
export coder_oauth2_github_allowed_teams=defn/dev
export coder_oauth2_github_client_id_${name}=
export coder_oauth2_github_client_secret_${name}=
export CODER_SERVER=${name}

create cloudflare tunnel to handle *.${name}.defn.run
https://one.dash.cloudflare.com/b79aab534a3aa420f993ca0c14fe0523/networks/tunnels/new
proxy to http://localhost:3000
create proxied CNAME from *.${name} to tunnelID.cfargotunnel.com

cd
sudo chmod 1777 /tmp/uscreens
screen -DRR coder
make chrome-dev-coder name=${name}
