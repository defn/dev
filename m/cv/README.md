# Computer Vision Gallery Management System

This system manages a comprehensive image processing and gallery generation pipeline with machine learning integrations for image enhancement and face manipulation.

## Design Guidelines

In go code, the only Javascript used is to generate the blurhashIndex map. Do not emit other Javascript go code.

All other javascript code goes into gallery.js. There is only one javascript file, gallery.js.

## Directory Structure

### Input Directories

#### Core Image Storage
- **`img/`** - Original full-size images downloaded from external sources
  - Contains JPEG images with original quality and resolution
  - Source for all image processing operations
  - Populated by `just download` and `just user` commands

- **`yes/`** - Approved/selected images for processing  
  - Contains JPEG files that have been manually curated
  - Used as filter for generating thumbnails and web galleries
  - Referenced in `t2` and thumbnail generation workflows

- **`no/`** - Rejected images and processing artifacts
  - Contains placeholders for failed/invalid images
  - Populated during thumbnail generation for GIFs and invalid files
  - Cleaned and recreated during `just eod` operations

#### Metadata and Configuration
- **`posts/`** - JSON metadata files for images
  - Contains `.json` files with image metadata, URLs, and post information
  - Generated from user content downloads
  - Used for content discovery and organization

- **`etc/`** - Configuration scripts and utilities
  - Contains helper scripts for user content fetching
  - Configuration files for various processing operations

#### Source Lists and Inputs
- **`all.input`** - Text file containing image identifiers for gallery generation
  - One image ID per line (without file extensions)
  - Generated by `find {{prefix}}t2 -type f | cut -d/ -f3 | cut -d. -f1 | sort`
  - Used as input to `blurmap.go` for gallery generation

- **`following.txt`** - List of usernames for batch processing
- **`urls.txt`** - Deduplicated list of image URLs extracted from JSON metadata
- **`js-username-*.json`** - User-specific metadata files
- **`js-*.js.json`** - Processed JSON files ready for download operations

### Processing Directories

#### Image Processing Pipeline
- **`thumbs/`** - 400px PNG thumbnails
  - Generated from `img/*.jpeg` files using ImageMagick
  - Format: `{image_id}.png`
  - Used for quick preview and gallery display
  - Generated by `just thumbs` with parallel processing (32 workers)

- **`t2/`** - Web-optimized images (400px PNG)
  - Resized versions of approved images from `yes/` directory
  - Format: `{image_id}.png`
  - Source for web gallery generation
  - Generated by `just t2` command

#### ESRGAN Super-Resolution Pipeline
- **`replicate/`** - ESRGAN processing workspace
  - **`replicate/js/`** - Processing metadata and results
    - Contains `.json` files with ESRGAN processing metadata
    - Processing parameters, timestamps, and model information
  - **`replicate/img/`** - Full-resolution enhanced images
    - High-quality ESRGAN output images
    - Source images enhanced through ML super-resolution
  - **`replicate/t2/`** - Web-optimized enhanced images (400px PNG)
    - Thumbnails generated from enhanced images
    - Used for enhanced image galleries

#### Face Manipulation Pipeline (FEM)
- **`pub/`** - Face manipulation workspace
  - **`pub/W/`** - Source images for face manipulation (.png)
  - **`pub/w-*/`** - Style/reference directories (e.g., w-01/, w-02/)
    - Each contains reference images for style transfer
    - Contains generated face-swapped outputs: `{style}-{source_image}`
  - **`pub/fm/`** - Face manipulation results organized by style

#### Video Processing Pipeline  
- **`v/`** - Video processing workspace
  - **`v/mp4/`** - Source video files
  - **`v/img/`** - Extracted video frames
    - Organized by video: `v/img/{video_name}/v-{video_name}-{frame}.jpeg`
    - Generated at 1 FPS using ffmpeg
  - **`v/html/`** - Generated HTML galleries for videos

### Output Directories

#### Web Gallery Output
- **`g/`** - Primary gallery HTML output (default for blurmap.go)
  - Contains paginated HTML files: `1.html`, `2.html`, etc.
  - Each page contains up to 500 images (configurable chunkSize)
  - Embedded JavaScript with image metadata and blurhash data
  - Responsive gallery layout with lazy loading

- **`tmp/`** - Temporary processing workspace
  - **`tmp/blur/`** - Temporary blurhash cache
  - **`tmp/g/`** - Temporary gallery outputs
    - User-specific galleries: `tmp/g/js-username-{user}.json.js.json.input/`

#### Cache Directories
- **`blur/`** - Blurhash and dimension cache (default for blurmap.go)
  - SHA256-based cache keys for reliable invalidation
  - Stores pre-computed blurhash data and image dimensions
  - Significantly speeds up gallery regeneration

#### Web Serving Structure
- **`W/`** - Generated HTML pages for W-series images
  - **`W.html`** - Master index with clickable thumbnails
  - **`W/{image}.html`** - Individual detail pages showing variants

### Database
- **`cv.db`** - SQLite database for image metadata
  - `img` table with columns: id, good, thumb_height, thumb_width
  - Populated by `just db-img` and `just db-size` commands
  - Used for data consistency and reporting

### Configuration Files
- **`proxy.conf`** - Nginx proxy configuration template
- **`package.json`** - Node.js dependencies for ESRGAN processing
- **`go.mod`** - Go module dependencies for gallery generation
- **`cog.yaml`** - Cog model configuration for ML processing

## Data Flow

### 1. Content Acquisition
```
External Sources → img/ (via wget)
                → posts/ (metadata JSON)
                → yes/ (manual curation)
```

### 2. Thumbnail Generation  
```
img/*.jpeg → thumbs/*.png (400px, parallel processing)
yes/*.jpeg → t2/*.png (400px, web-optimized)
```

### 3. Gallery Generation
```
t2/*.png → all.input (image list)
         → g/*.html (paginated galleries via blurmap.go)
         → blur/ (blurhash cache)
```

### 4. ESRGAN Enhancement
```
t2/*.png → replicate/img/*.png (super-resolution)
        → replicate/t2/*.png (thumbnails)
        → replicate/js/*.json (metadata)
```

### 5. Face Manipulation
```
pub/W/*.png + pub/w-*/*.png → pub/w-*/{style}-{image} (face-swapped results)
```

### 6. Video Processing
```
v/mp4/*.mp4 → v/img/{video}/*.jpeg (frame extraction)
           → v/html/{video}.html (video galleries)
```

## Key Commands

- **`just gallery`** - Generate web gallery from replicate/t2/
- **`just w-galleries`** - Generate all w-* workflow galleries in batch
- **`just html`** - Generate per-user galleries with selection mode
- **`just thumbs`** - Create thumbnails from img/ to thumbs/
- **`just t2`** - Create web-optimized images from yes/ to t2/
- **`just ersgan n`** - Run ESRGAN super-resolution (n parallel processes)
- **`just user username`** - Download and process user content
- **`just backup n`** - Sync replicate/ to remote storage (n transfer threads)

## Gallery Generation with blurmap.go

The `blurmap.go` program generates HTML galleries with blurhash placeholders. It operates in three explicit modes, each with different inputs, outputs, and interaction behaviors.

### Mode 1: Gallery Mode (Main Gallery)

**Command:** `just gallery`

**Expands to:** `go run blurmap.go -mode gallery -scan-dir replicate/t2`

**Purpose:** Generate the main gallery from replicate/t2 images

**Inputs:**
- Scans directory: `replicate/t2/` (400px thumbnails)
- Auto-discovers all PNG/JPEG images
- Cache directory: `blur/`

**Outputs:**
- Gallery pages: `g/1/index.html`, `g/2/index.html`, etc.
- Click behavior: `toggle` - Click images to toggle blurhash overlay on/off (visual-only, no server interaction)

**When to use:** After updating replicate/t2 with new ESRGAN-enhanced images

**Note:** The `-scan-dir` flag eliminates the need for generating `all.input` file. Images are discovered automatically.

---

### Mode 2: HTML Mode (Per-User Galleries)

**Command:** `just html`

**Expands to:** `go run blurmap.go -mode html -json js-username-<user>.json.js.json -o tmp/g/js-username-<user> -generate-index following.html`

**Purpose:** Generate per-user galleries with selection capability for curation

**Inputs:**
- JSON file: `js-username-*.json.js.json` (user metadata with image URLs)
- Automatically extracts URLs and filters images by:
  - Must have thumbnail in `thumbs/`
  - Must NOT be in `yes/` (already approved)
  - Must NOT be in `no/` (already rejected)
- Image directory: `thumbs/` (400px thumbnails)
- Cache directory: `tmp/blur/`

**Outputs:**
- Gallery pages: `tmp/g/js-username-<user>/1/index.html`, etc.
- Index file: `following.html` (links to all generated galleries)
- Click behavior: `select` - Click images to toggle blurhash AND send selection to server for curation

**When to use:** When curating images from specific users

**Note:** The `-json-file` flag eliminates the need for separate `index` and `process` targets. Filtering happens automatically inside blurmap.go.

---

### Mode 3: Batch Mode (W-* Workflow Galleries)

**Command:** `just w-galleries`

**Expands to:** `go run blurmap.go -mode batch`

**Purpose:** Generate all workflow galleries with navigation to detail pages

**Inputs:**
- Source directories: `pub/fm/w-00/`, `pub/fm/w-01/`, ..., `pub/fm/w-999/`
- Processes all w-* directories automatically
- Cache directory: `tmp/blur/`

**Outputs:**
- Gallery pages: `pub/w/w-00/1/index.html`, `pub/w/w-01/1/index.html`, etc.
- Master gallery: `pub/w/g/1/index.html` (aggregates all workflows)
- Click behavior: `navigate` - Click images to open detail page at `W/{uuid}.html`

**When to use:** After generating new face-manipulation results in pub/fm/w-* directories

---

### Click Mode Behaviors

- **toggle:** Click to show/hide blurhash overlay (keyboard: `b` key). Visual feedback only, no data sent to server.
- **select:** Click to toggle blurhash AND send selection to server endpoint for image curation workflow.
- **navigate:** Click to navigate to detail page showing all variants of the image.

### Manual Invocation

You can also run blurmap.go directly with explicit parameters:

```bash
# Gallery mode - scan directory for images
go run blurmap.go -mode gallery -scan-dir replicate/t2 -o g -c blur

# HTML mode - process JSON with filtering
go run blurmap.go -mode html \
  -json js-username-user.json.js.json \
  -o tmp/g/js-username-user \
  -stage1 yes -stage2 no -thumbs-dir thumbs \
  -generate-index following.html

# Batch mode - process all w-* directories
go run blurmap.go -mode batch
```

**Core Flags:**
- `-mode` or `-m`: Operating mode (required: `gallery`, `html`, or `batch`)
- `-output` or `-o`: Output directory for HTML files
- `-cache` or `-c`: Cache directory for blurhash data
- `-imagedir` or `-d`: Source image directory (usually auto-set)
- `-selectmode` or `-s`: Override click mode (`no`, `yes`, `navigate`)

**Gallery Mode Flags:**
- `-scan-dir`: Directory to scan for images (required)

**HTML Mode Flags:**
- `-json-file` or `-json`: JSON file with image metadata (required)
- `-stage1`: First stage directory for filtering (default: `yes`)
- `-stage2`: Second stage directory for filtering (default: `no`)
- `-thumbs-dir`: Thumbnails directory (default: `thumbs`)
- `-generate-index`: Generate index file with all gallery links

Run `go run blurmap.go -help` for complete usage information.

## Processing Notes

- **Parallel Processing**: Most operations use `runmany` for concurrent execution
- **Caching**: Blurhash and dimension data cached with SHA256 keys
- **Format Handling**: JPEG→PNG conversion for web optimization
- **Error Handling**: Invalid images marked in `no/` directory
- **Pagination**: Gallery HTML split into 500-image chunks
- **Responsive Design**: CSS/JavaScript provide adaptive layouts