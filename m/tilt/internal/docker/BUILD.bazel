load("@io_bazel_rules_go//go:def.bzl", "go_library", "go_test")

go_library(
    name = "docker",
    srcs = [
        "client.go",
        "clients.go",
        "env.go",
        "exploding.go",
        "fake_client.go",
        "image.go",
        "options.go",
        "readcloser.go",
        "run.go",
        "state.go",
        "switch.go",
        "test_state.go",
        "wire.go",
    ],
    importpath = "github.com/defn/dev/m/tilt/internal/docker",
    visibility = ["//tilt:__subpackages__"],
    deps = [
        "//tilt/internal/container",
        "//tilt/internal/docker/buildkit",
        "//tilt/internal/k8s",
        "//tilt/pkg/apis/core/v1alpha1",
        "//tilt/pkg/logger",
        "//tilt/pkg/model",
        "@com_github_blang_semver//:semver",
        "@com_github_distribution_reference//:reference",
        "@com_github_docker_cli//cli/command",
        "@com_github_docker_cli//cli/config",
        "@com_github_docker_cli//cli/flags",
        "@com_github_docker_cli//opts",
        "@com_github_docker_docker//api/types",
        "@com_github_docker_docker//api/types/container",
        "@com_github_docker_docker//api/types/filters",
        "@com_github_docker_docker//api/types/image",
        "@com_github_docker_docker//api/types/mount",
        "@com_github_docker_docker//api/types/registry",
        "@com_github_docker_docker//client",
        "@com_github_docker_docker//pkg/stdcopy",
        "@com_github_docker_docker//registry",
        "@com_github_docker_go_connections//tlsconfig",
        "@com_github_docker_go_units//:go-units",
        "@com_github_google_wire//:wire",
        "@com_github_moby_buildkit//identity",
        "@com_github_moby_buildkit//session",
        "@com_github_moby_buildkit//session/auth/authprovider",
        "@com_github_moby_buildkit//session/filesync",
        "@com_github_opencontainers_go_digest//:go-digest",
        "@com_github_pkg_errors//:errors",
        "@com_github_spf13_pflag//:pflag",
        "@com_github_tilt_dev_clusterid//:clusterid",
        "@org_golang_x_sync//errgroup",
    ],
)

go_test(
    name = "docker_test",
    srcs = [
        "client_integration_test.go",
        "client_test.go",
        "env_test.go",
    ],
    embed = [":docker"],
    deps = [
        "//tilt/internal/container",
        "//tilt/internal/k8s",
        "//tilt/internal/testutils",
        "@com_github_distribution_reference//:reference",
        "@com_github_docker_docker//api/types",
        "@com_github_stretchr_testify//assert",
        "@com_github_stretchr_testify//require",
        "@com_github_tilt_dev_clusterid//:clusterid",
    ],
)
