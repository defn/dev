load("@io_bazel_rules_go//go:def.bzl", "go_library", "go_test")

go_library(
    name = "server",
    srcs = [
        "actions.go",
        "apiserver.go",
        "controller.go",
        "logs_reader.go",
        "server.go",
        "serving.go",
        "token.go",
        "websocket.go",
        "websocketlist.go",
        "wire.go",
    ],
    importpath = "github.com/defn/dev/m/tilt/internal/hud/server",
    visibility = ["//tilt:__subpackages__"],
    deps = [
        "//tilt/internal/analytics",
        "//tilt/internal/filelock",
        "//tilt/internal/hud",
        "//tilt/internal/hud/server/gorilla",
        "//tilt/internal/hud/webview",
        "//tilt/internal/store",
        "//tilt/internal/store/tiltfiles",
        "//tilt/internal/xdg",
        "//tilt/pkg/apis/core/v1alpha1",
        "//tilt/pkg/assets",
        "//tilt/pkg/logger",
        "//tilt/pkg/model",
        "//tilt/pkg/model/logstore",
        "//tilt/pkg/openapi",
        "//tilt/pkg/webview",
        "@com_github_akutz_memconn//:memconn",
        "@com_github_golang_protobuf//jsonpb",
        "@com_github_google_uuid//:uuid",
        "@com_github_google_wire//:wire",
        "@com_github_gorilla_mux//:mux",
        "@com_github_gorilla_websocket//:websocket",
        "@com_github_grpc_ecosystem_grpc_gateway//runtime",
        "@com_github_json_iterator_go//:go",
        "@com_github_pkg_errors//:errors",
        "@com_github_tilt_dev_tilt_apiserver//pkg/server/apiserver",
        "@com_github_tilt_dev_tilt_apiserver//pkg/server/builder",
        "@com_github_tilt_dev_tilt_apiserver//pkg/server/options",
        "@com_github_tilt_dev_tilt_apiserver//pkg/server/start",
        "@com_github_tilt_dev_tilt_apiserver//pkg/server/testdata",
        "@com_github_tilt_dev_wmclient//pkg/analytics",
        "@com_github_tilt_dev_wmclient//pkg/dirs",
        "@io_k8s_apimachinery//pkg/apis/meta/v1:meta",
        "@io_k8s_apimachinery//pkg/types",
        "@io_k8s_apimachinery//pkg/util/runtime",
        "@io_k8s_apiserver//pkg/server",
        "@io_k8s_client_go//dynamic",
        "@io_k8s_client_go//rest",
        "@io_k8s_client_go//tools/clientcmd",
        "@io_k8s_client_go//tools/clientcmd/api",
        "@io_k8s_client_go//util/workqueue",
        "@io_k8s_kubectl//pkg/proxy",
        "@io_k8s_sigs_controller_runtime//pkg/client",
        "@org_golang_google_protobuf//types/known/timestamppb",
    ],
)

go_test(
    name = "server_test",
    srcs = [
        "apiserver_test.go",
        "logs_reader_test.go",
        "server_test.go",
        "websocket_reader_test.go",
        "websocket_test.go",
    ],
    embed = [":server"],
    deps = [
        "//tilt/internal/analytics",
        "//tilt/internal/controllers/fake",
        "//tilt/internal/hud",
        "//tilt/internal/hud/view",
        "//tilt/internal/k8s/testyaml",
        "//tilt/internal/sliceutils",
        "//tilt/internal/store",
        "//tilt/internal/testutils",
        "//tilt/internal/testutils/bufsync",
        "//tilt/internal/testutils/tempdir",
        "//tilt/pkg/apis/core/v1alpha1",
        "//tilt/pkg/assets",
        "//tilt/pkg/logger",
        "//tilt/pkg/model",
        "//tilt/pkg/webview",
        "@com_github_golang_protobuf//jsonpb",
        "@com_github_stretchr_testify//assert",
        "@com_github_stretchr_testify//require",
        "@com_github_tilt_dev_tilt_apiserver//pkg/server/apiserver",
        "@com_github_tilt_dev_tilt_apiserver//pkg/server/testdata",
        "@com_github_tilt_dev_wmclient//pkg/analytics",
        "@com_github_tilt_dev_wmclient//pkg/dirs",
        "@io_k8s_apimachinery//pkg/api/meta",
        "@io_k8s_apimachinery//pkg/apis/meta/v1:meta",
        "@io_k8s_apimachinery//pkg/apis/meta/v1/unstructured",
        "@io_k8s_apimachinery//pkg/types",
        "@io_k8s_client_go//tools/clientcmd",
        "@io_k8s_sigs_controller_runtime//pkg/client",
    ],
)
