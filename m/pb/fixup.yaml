---
# fixup.yaml - Ansible playbook for system configuration fixes and setup
# Purpose: Fixes various system configurations, permissions, and tool integrations
# Usage: ansible-playbook fixup.yaml -i inventory
# Dependencies: Requires mise tool manager and development tools
# Variables:
#   - user_id: User ID (default: 1000)
#   - group_id: Group ID (default: 100)
#   - username: Username derived from user_id
#   - groupname: Group name derived from user_id
#   - home_dir: User home directory
#   - docker_config_dir: Docker configuration directory
- name: Setup Docker and SSH configs
  hosts: all
  vars:
    username: "{{ ansible_user_id }}"
    home_dir: "{{ ansible_env.HOME }}"
    user_id: "{{ ansible_user_uid }}"
    group_id: "{{ ansible_user_gid }}"
    groupname: "{{ ansible_user_id }}"
    docker_config_dir: "{{ home_dir }}/.docker"

  tasks:
    - name: Comment out GSSAPIAuthentication in ssh_config
      become: true
      lineinfile:
        path: /etc/ssh/ssh_config
        regexp: '^\s*GSSAPIAuthentication'
        line: "#GSSAPIAuthentication"
        state: present
      when: ansible_os_family != "Darwin"

    - name: Remove docker credential helpers if they exist
      become: true
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ lookup('pipe', 'which docker-credential-pass || true') }}"
        - "{{ lookup('pipe', 'which docker-credential-secretservice || true') }}"
      when:
        - ansible_os_family != "Darwin"
        - item != ""

    - name: Copy config.json.example to config.json if not exists
      become: true
      copy:
        src: "{{ docker_config_dir }}/config.json.example"
        dest: "{{ docker_config_dir }}/config.json"
        owner: "{{ username }}"
        group: "{{ groupname }}"
        mode: "0600"
        remote_src: yes
      when:
        - ansible_os_family != "Darwin"
        - not lookup('file', docker_config_dir + '/config.json', errors='ignore')

    - name: Add user to docker group
      become: true
      user:
        name: "{{ username }}"
        groups: docker
        append: yes
      when: ansible_os_family != "Darwin"

    - name: Generate locale
      become: true
      when: ansible_os_family != "Darwin"
      block:
        - name: Generate locale
          command: "locale-gen en_US.UTF-8"
          changed_when: false

        - name: Update system locale
          command: "update-locale en_US.UTF-8"
          changed_when: false

    - name: Create standard directories
      become: true
      file:
        state: directory
        owner: "{{username}}"
        group: "{{groupname}}"
        path: "{{ item.path }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: "/home/{{username}}", mode: "0700" }
        - { path: "/home/{{username}}/.cache/go-mod", mode: "0755" }
        - { path: "/home/{{username}}/.cache/go-build", mode: "0755" }
        - { path: "/home/{{username}}/.cache/helm", mode: "0755" }
        - { path: "/home/{{username}}/.terraform.d/plugin-cache", mode: "0755" }
        - { path: "/home/{{username}}/work", mode: "0755" }
        - { path: "/run/user/{{user_id}}", mode: "0700" }
        - { path: "/run/user/{{user_id}}/gnupg", mode: "0700" }
      when: ansible_os_family != "Darwin"

    - name: Create tmp directories
      become: true
      file:
        state: directory
        owner: root
        group: root
        path: "{{ item.path }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: "/tmp/uscreens", mode: "1777" }
      when: ansible_os_family != "Darwin"

    - name: Delete ansible files from ~/.local/bin
      become: false
      ansible.builtin.shell: |
        rm -f /home/{{ username }}/.local/bin/ansible*
      when: ansible_os_family != "Darwin"

    - name: Find full path to mise tool
      become: false
      ansible.builtin.command: >
        ~/bin/with-env mise exec --cd ~/m -- which {{ item }}
      register: mise_paths
      args:
        chdir: /home/ubuntu
      loop:
        - agentapi
        - bazel
        - buildifier
        - coder
        - cue
        - devcontainer
        - go
        - node
        - npm
        - npx
        - pip
        - pip3
        - python
        - python3
      changed_when: false
    - name: Make /usr/local/bin
      become: true
      file:
        state: directory
        owner: root
        group: "{{ 'wheel' if ansible_os_family == 'Darwin' else 'root' }}"
        path: "/usr/local/bin"
        mode: "0755"
    - name: Create symlinks in /usr/local/bin
      become: true
      ansible.builtin.file:
        src: "{{ item.stdout }}"
        dest: "/usr/local/bin/{{ item.item }}"
        state: link
        force: true
      loop: "{{ mise_paths.results }}"

    - name: Create symlinks for home bin tools in /usr/local/bin
      become: true
      ansible.builtin.file:
        src: "{{ home_dir }}/.bin/{{ item }}"
        dest: "/usr/local/bin/{{ item }}"
        state: link
        force: true
      loop:
        - claude
