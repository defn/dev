---
# fixup.yaml - Ansible playbook for system configuration fixes and setup
# Purpose: Fixes various system configurations, permissions, and tool integrations
# Usage: ansible-playbook fixup.yaml -i inventory
# Dependencies: Requires mise tool manager and development tools
# Variables:
#   - user_id: User ID (default: 1000)
#   - group_id: Group ID (default: 100)
#   - username: Username derived from user_id
#   - groupname: Group name derived from user_id
#   - home_dir: User home directory
#   - docker_config_dir: Docker configuration directory
- name: Setup Docker and SSH configs
  hosts: all
  vars:
    user_id: 1000
    group_id: 100
    username: "{{ lookup('pipe', 'id -un 1000') }}"
    groupname: "{{ lookup('pipe', 'id -gn 1000') }}"
    home_dir: "/home/{{ username }}"
    docker_config_dir: "{{ home_dir }}/.docker"

  tasks:
    - name: Comment out GSSAPIAuthentication in ssh_config
      become: true
      lineinfile:
        path: /etc/ssh/ssh_config
        regexp: '^\s*GSSAPIAuthentication'
        line: "#GSSAPIAuthentication"
        state: present

    - name: Remove docker credential helpers if they exist
      become: true
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ lookup('pipe', 'which docker-credential-pass || true') }}"
        - "{{ lookup('pipe', 'which docker-credential-secretservice || true') }}"
      when: item != ""

    - name: Copy config.json.example to config.json if not exists
      become: true
      copy:
        src: "{{ docker_config_dir }}/config.json.example"
        dest: "{{ docker_config_dir }}/config.json"
        owner: "{{ username }}"
        group: "{{ groupname }}"
        mode: "0600"
        remote_src: yes
      when: not lookup('file', docker_config_dir + '/config.json', errors='ignore')

    - name: Add user to docker group
      become: true
      user:
        name: "{{ username }}"
        groups: docker
        append: yes

    - name: Generate locale
      become: true
      block:
        - name: Generate locale
          command: "locale-gen en_US.UTF-8"
          changed_when: false

        - name: Update system locale
          command: "update-locale en_US.UTF-8"
          changed_when: false

    - name: Create standard directories
      become: true
      file:
        state: directory
        owner: "{{username}}"
        group: "{{groupname}}"
        path: "{{ item.path }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: "/home/{{username}}", mode: "0700" }
        - { path: "/home/{{username}}/.cache/go-mod", mode: "0755" }
        - { path: "/home/{{username}}/.cache/go-build", mode: "0755" }
        - { path: "/home/{{username}}/.cache/helm", mode: "0755" }
        - { path: "/home/{{username}}/work", mode: "0755" }
        - { path: "/run/user/{{user_id}}", mode: "0700" }
        - { path: "/run/user/{{user_id}}/gnupg", mode: "0700" }

    - name: Create tmp directories
      become: true
      file:
        state: directory
        owner: root
        group: root
        path: "{{ item.path }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: "/tmp/uscreens", mode: "1777" }
    
    - name: Delete ansible files from ~/.local/bin
      become: false
      ansible.builtin.shell: |
        rm -f /home/{{ username }}/.local/bin/ansible*
      
    - name: Find full path to mise tool
      become: false
      ansible.builtin.command: >
        ~/bin/with-env mise exec --cd ~/m -- which {{ item }}
      register: mise_paths
      args:
        chdir: /home/ubuntu
      loop:
        - cue
        - go
        - claude
        - node
        - agentapi
        - devcontainer
        - coder
        - gemini
        - codex
      changed_when: false
    - name: Make /usr/local/bin
      become: true
      file:
        state: directory
        owner: root
        group: root
        path: "/usr/local/bin"
        mode: "0755"
    - name: Create symlinks in /usr/local/bin
      become: true
      ansible.builtin.file:
        src: "{{ item.stdout }}"
        dest: "/usr/local/bin/{{ item.item }}"
        state: link
        force: true
      loop: "{{ mise_paths.results }}"
