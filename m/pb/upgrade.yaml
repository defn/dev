---
# upgrade.yaml - System package upgrade and maintenance playbook
# Purpose: Updates and upgrades all apt packages with error handling and cleanup
# Usage: ansible-playbook upgrade.yaml -i inventory
# Dependencies: Ubuntu or Debian OS, sudo privileges
# Features:
#   - Fixes broken dpkg configurations
#   - Updates package cache and upgrades all packages
#   - Removes unnecessary packages (autoremove)
#   - Includes retry logic for reliability
- name: Upgrade all packages
  hosts: all
  become: true
  tasks:
    - name: Fail if not Ubuntu or Debian
      fail:
        msg: "This playbook only supports Ubuntu or Debian systems."
      when: ansible_facts['os_family'] != "Debian"
    - name: Fix dpkg
      shell: sudo dpkg --configure -a || true
      args:
        executable: /bin/bash
    - name: Autoremove packages
      shell: sudo apt -o DPkg::Lock::Timeout=-1 autoremove -y || true
      args:
        executable: /bin/bash
    - name: Update apt packages
      apt:
        upgrade: "yes"
        update_cache: "yes"
      register: apt_update
      until: apt_update is success
      retries: 5
      delay: 30
    - name: Autoremove packages
      shell: sudo apt -o DPkg::Lock::Timeout=-1 autoremove -y || true
      args:
        executable: /bin/bash
