---
# ubuntu.yaml - Comprehensive Ubuntu/Debian system setup playbook
# Purpose: Sets up a complete development environment on Ubuntu/Debian systems
# Usage: ansible-playbook ubuntu.yaml -i inventory
# Dependencies: Ubuntu or Debian OS, sudo privileges
# Features:
#   - Disables automatic updates
#   - Installs development packages (build tools, git, docker, etc.)
#   - Configures Docker and user permissions
#   - Sets up passwordless sudo for ubuntu user
- name: Ubuntu setup
  hosts: all
  tasks:
    - name: Fail if not Ubuntu or Debian
      fail:
        msg: "This playbook only supports Ubuntu or Debian systems."
      when: ansible_facts['os_family'] != "Debian"
    - name: Disable apt-daily.timer
      become: true
      ignore_errors: true
      service:
        name: apt-daily.timer
        enabled: "no"
        state: stopped
    - name: Disable apt-daily-upgrade.timer
      become: true
      ignore_errors: true
      service:
        name: apt-daily-upgrade.timer
        enabled: "no"
        state: stopped
    - name: Disable unattended-upgrades service
      become: true
      ignore_errors: true
      service:
        name: unattended-upgrades
        enabled: "no"
        state: stopped
    - name: Remove packages
      become: true
      apt:
        name:
          - nano
          - unattended-upgrades
        state: absent
    - name: Install base packages
      become: true
      apt:
        name:
          - bc
          - bind9-dnsutils
          - build-essential
          - ca-certificates
          - cpu-checker
          - curl
          - dirmngr
          - gettext
          - git
          - git-lfs
          - gpg
          - gpg-agent
          - htop
          - ifupdown
          - iproute2
          - iptables
          - locales
          - lsb-release
          - make
          - ncdu
          - net-tools
          - openssh-client
          - pass
          - pcscd
          - pv
          - python-is-python3
          - python3-venv
          - rsync
          - s6
          - scdaemon
          - skopeo
          - socat
          - sudo
          - tini
          - tzdata
          - vim-nox
          - xz-utils
        state: present
    - name: Ensure /etc/apt/keyrings directory exists
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"
    - name: Download Docker Ubuntu GPG key
      become: true
      get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker-ubuntu.asc
        mode: "0644"
    - name: Download Docker Debian GPG key
      become: true
      get_url:
        url: https://download.docker.com/linux/debian/gpg
        dest: /etc/apt/keyrings/docker-debian.asc
        mode: "0644"
    - name: Add Docker APT repository for Ubuntu
      become: true
      copy:
        dest: /etc/apt/sources.list.d/docker.list
        content: |
          deb [arch={{ ansible_architecture | regex_replace('x86_64','amd64') | regex_replace('aarch64','arm64') }} signed-by=/etc/apt/keyrings/docker-ubuntu.asc] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable
        mode: "0644"
      when: ansible_distribution == "Ubuntu"
    - name: Add Docker APT repository for Debian
      become: true
      copy:
        dest: /etc/apt/sources.list.d/docker.list
        content: |
          deb [arch={{ ansible_architecture | regex_replace('x86_64','amd64') | regex_replace('aarch64','arm64') }} signed-by=/etc/apt/keyrings/docker-debian.asc] https://download.docker.com/linux/debian {{ ansible_lsb.codename }} stable
        mode: "0644"
      when: ansible_distribution == "Debian"
    - name: Update APT cache
      become: true
      apt:
        update_cache: yes

    - name: Install Docker packages
      become: true
      ignore_errors: true
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
    - name: Remove files
      become: true
      file:
        path:
          - /usr/bin/gs
          - /home/ubuntu/bin/Linux/bazel
          - /home/ubuntu/bin/Linux/go
          - /home/ubuntu/bin/Linux/cue
        state: absent
    - name: Allow user to run Docker
      become: true
      ignore_errors: true
      user:
        name: ubuntu
        groups: docker
        append: "yes"
    - name: Create /etc/apt/apt.conf.d directory
      become: true
      file:
        path: /etc/apt/apt.conf.d
        state: directory
        owner: root
        group: root
        mode: "0755"
    - name: Delete old apt config
      become: true
      file:
        path: /etc/apt/apt.conf.d/99-Phased-Updates
        state: absent
    - name: Add NOPASSWD to sudoers.d for user
      become: true
      copy:
        content: "ubuntu ALL=(ALL:ALL) NOPASSWD: ALL"
        dest: /etc/sudoers.d/ubuntu
        mode: "0440"
    - name: Link gitconfig
      file:
        src: ".gitconfig.default"
        dest: "/home/ubuntu/.gitconfig"
        state: link
        force: yes
