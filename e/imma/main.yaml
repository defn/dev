apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: imma
  namespace: argocd
  labels:
    argocd.argoproj.io/instance: sets
spec:
  generators:
    - list:
        elements:
          - name: argocd
            namespace: argocd
            cluster: in-cluster
            path: argocd
          - name: argocd-ingress
            namespace: argocd
            cluster: in-cluster
            path: argocd-ingress
          - name: cert-manager
            namespace: cert-manager
            cluster: in-cluster
            path: cert-manager
          - name: kyverno
            namespace: kyverno
            cluster: in-cluster
            path: kyverno
          - name: external-secrets
            namespace: external-secrets
            cluster: in-cluster
            path: external-secrets
          - name: external-dns
            namespace: external-dns
            cluster: in-cluster
            path: external-dns
          - name: argo-events
            namespace: argo-events
            cluster: in-cluster
            path: argo-events
          - name: argo-workflows
            namespace: argo-workflows
            cluster: in-cluster
            path: argo-workflows
          - name: dex
            namespace: dex
            cluster: in-cluster
            path: dex
          - name: traefik
            namespace: traefik
            cluster: in-cluster
            path: traefik
          - name: traefik-forward-auth
            namespace: traefik
            cluster: in-cluster
            path: traefik-forward-auth
          - name: vcluster
            namespace: vcluster
            cluster: in-cluster
            path: vcluster
          - name: dev
            namespace: default
            cluster: in-cluster
            path: dev
  template:
    metadata:
      name: "imma-{{name}}"
      namespace: argocd
    spec:
      project: default
      source:
        repoURL: https://github.com/defn/dev
        path: k/{{path}}
        targetRevision: main
      destination:
        namespace: "{{namespace}}"
        name: "{{cluster}}"
      syncPolicy:
        syncOptions:
          - CreateNamespace=true
        automated:
          prune: true
      ignoreDifferences:
        - kind: MutatingWebhookConfiguration
          group: admissionregistration.k8s.io
          name: vault-agent-injector-cfg
          jsonPointers:
            - /webhooks/0/clientConfig/caBundle
        - kind: MutatingWebhookConfiguration
          group: admissionregistration.k8s.io
          name: webhook.domainmapping.serving.knative.dev
          jsonPointers:
            - /webhooks/0/rules
        - kind: MutatingWebhookConfiguration
          group: admissionregistration.k8s.io
          name: webhook.serving.knative.dev
          jsonPointers:
            - /webhooks/0/rules
        - kind: ValidatingWebhookConfiguration
          group: admissionregistration.k8s.io
          name: validation.webhook.serving.knative.dev
          jsonPointers:
            - /webhooks/0/rules
        - kind: ValidatingWebhookConfiguration
          group: admissionregistration.k8s.io
          name: validation.webhook.domainmapping.serving.knative.dev
          jsonPointers:
            - /webhooks/0/rules
        - kind: Deployment
          group: apps
          name: kong-kong
          jsonPointers:
            - /spec/template/spec/tolerations
        - group: kyverno.io
          kind: ClusterPolicy
          jqPathExpressions:
            - .spec.rules[] | select(.name|test("autogen-."))
